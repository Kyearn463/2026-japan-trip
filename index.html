<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2026 日本雙城之旅</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet Map -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap"
          rel="stylesheet">

    <style>
        /* --- 全域設定 --- */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            overflow: hidden;
            background-color: #f1f5f9;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* UI 元件 */
        .day-pill.active {
            background-color: #0f172a;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3);
        }

        .day-pill {
            transition: all 0.3s ease;
        }

        /* --- 底部抽屜 (Bottom Sheet) --- */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 0 -5px 40px rgba(0, 0, 0, 0.15);
            transition: height 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 500;
            display: flex;
            flex-direction: column;
        }

        .sheet-min {
            height: 160px;
        }

        .sheet-half {
            height: 50vh;
        }

        .sheet-full {
            height: 92vh;
        }

        /* 詳細資訊 Modal */
        .detail-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .detail-modal.open {
            pointer-events: auto;
            opacity: 1;
        }

        .detail-modal-bg {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .detail-card {
            background: white;
            width: 100%;
            max-width: 500px;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .detail-modal.open .detail-card {
            transform: translateY(0);
        }

        /* PDF 預覽 Modal */
        .pdf-modal {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .pdf-modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- 專屬 Icon 地圖標記樣式 --- */
        .custom-marker {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .custom-marker:hover, .custom-marker.active {
            transform: scale(1.15);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.4);
            z-index: 100 !important;
        }

        /* 顏色主題 */
        .bg-spot {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .bg-food {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .bg-hotel {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .bg-transport {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .bg-nearby {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        /* 距離標籤 */
        .dist-label-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 160px;
            pointer-events: none;
        }

        .dist-label {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: white;
            padding: 6px 14px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
            transform: translateY(-50px);
            white-space: nowrap;
        }

        /* 航班卡片 */
        .flight-card {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: transform 0.2s;
        }

        .flight-card:active {
            transform: scale(0.98);
            background-color: #f8fafc;
        }

        /* 抽屜把手 */
        .sheet-handle-area {
            width: 100%;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .sheet-handle-bar {
            width: 40px;
            height: 5px;
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* 倒數計時數字盒 */
        .countdown-box {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 4px 8px;
            text-align: center;
            min-width: 45px;
        }

        .countdown-label {
            font-size: 9px;
            opacity: 0.8;
            text-transform: uppercase;
            margin-top: -2px;
        }

        /* Desktop RWD */
        @media (min-width: 768px) {
            .bottom-sheet {
                width: 400px;
                height: 85vh !important;
                top: 80px;
                left: 30px;
                bottom: auto;
                border-radius: 24px;
                border: 1px solid rgba(255, 255, 255, 0.8);
            }

            .day-selector-container {
                width: 400px;
                left: 30px;
                top: 20px;
                padding: 0 !important;
                background: transparent !important;
            }

            .sheet-handle-area {
                display: none;
            }

            .sheet-min, .sheet-half, .sheet-full {
                height: auto;
            }

            .detail-modal {
                align-items: center;
            }

            .detail-card {
                border-radius: 24px;
                height: auto;
                max-height: 80vh;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }
        }
    </style>
</head>
<body>

<!-- 地圖 -->
<div id="map"></div>

<!-- UI 層 -->
<div class="fixed inset-0 pointer-events-none z-10">
    <!-- 頂部日期選單 -->
    <div
        class="day-selector-container absolute top-0 left-0 w-full pt-4 px-4 bg-gradient-to-b from-white/95 to-transparent md:bg-none pointer-events-auto z-20">
        <div class="flex overflow-x-auto no-scrollbar gap-2 pb-2 snap-x" id="day-tabs"></div>
    </div>

    <!-- 浮動定位按鈕 -->
    <div class="absolute top-24 right-4 flex flex-col gap-3 pointer-events-auto md:right-8 md:top-8 z-20">
        <button onclick="locateUser(true)"
                class="w-12 h-12 bg-white rounded-full shadow-xl flex items-center justify-center text-pink-500 hover:scale-110 transition border-2 border-pink-50">
            <i class="fas fa-location-arrow text-xl"></i>
        </button>
    </div>

    <!-- 底部抽屜 -->
    <div id="bottom-sheet" class="bottom-sheet pointer-events-auto sheet-half shadow-2xl">
        <div class="sheet-handle-area" onclick="cycleSheetHeight()">
            <div class="sheet-handle-bar"></div>
        </div>

        <!-- 倒數計時區 -->
        <div id="countdown-area"></div>

        <!-- 頭部資訊 -->
        <div
            class="px-6 py-3 border-b border-slate-100 flex justify-between items-center bg-white/60 backdrop-blur-md sticky top-0 z-20">
            <div>
                <h2 class="text-xl font-bold text-slate-800" id="day-title">Day 1</h2>
                <div class="text-xs text-slate-500 font-medium" id="day-date">...</div>
            </div>
            <div class="text-right">
                <div class="flex items-center justify-end gap-2">
                    <i class="fas fa-spinner fa-spin text-slate-400" id="weather-icon"></i>
                    <span class="text-2xl font-bold text-slate-700" id="weather-temp">--°</span>
                </div>
                <span class="text-[10px] text-slate-400 font-bold" id="weather-desc">載入中</span>
            </div>
        </div>

        <!-- 內容列表 -->
        <div class="flex-1 overflow-y-auto no-scrollbar" id="sheet-content">
            <div class="py-5 pr-5 pl-0 space-y-4" id="timeline-container"></div>

            <!-- 附近探索 -->
            <div class="pl-5 pr-2 pb-12 pt-6 bg-slate-50/80 border-t border-slate-100">
                <div class="flex justify-between items-center mb-3 pr-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider">
                        <i class="fas fa-radar text-blue-500 mr-1.5"></i>附近探索
                    </h3>
                </div>
                <div class="flex overflow-x-auto no-scrollbar gap-3 pb-2" id="nearby-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- 詳細資訊 Modal -->
<div id="detail-modal" class="detail-modal">
    <div class="detail-modal-bg" onclick="closeModal()"></div>
    <div class="detail-card relative">
        <button onclick="closeModal()"
                class="absolute top-4 right-4 z-20 w-8 h-8 bg-black/30 text-white rounded-full flex items-center justify-center backdrop-blur-md hover:bg-black/50 transition">
            <i class="fas fa-times"></i>
        </button>
        <div class="overflow-y-auto no-scrollbar h-full flex flex-col">
            <div class="h-56 w-full relative flex-shrink-0">
                <img id="modal-img" src="" alt="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                <div class="absolute bottom-4 left-6 text-white pr-4">
                    <div class="text-xs font-bold px-2 py-0.5 rounded inline-block mb-1 text-white" id="modal-tag">
                        TAG
                    </div>
                    <h2 class="text-2xl font-bold leading-tight" id="modal-title">Title</h2>
                </div>
            </div>
            <div class="p-6 flex-1 flex flex-col">
                <div class="flex-1">
                    <p class="text-slate-700 leading-relaxed text-sm text-justify mb-4" id="modal-desc"></p>
                    <div class="bg-amber-50 border border-amber-100 rounded-xl p-4 mb-4">
                        <h3 class="text-xs font-bold text-amber-600 uppercase mb-1">
                            <i class="fas fa-lightbulb mr-1.5"></i>Tips
                        </h3>
                        <p class="text-slate-700 text-sm" id="modal-tips"></p>
                    </div>
                </div>
                <a id="modal-nav-btn" href="#" target="_blank"
                   class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-center shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 mt-auto">
                    <i class="fas fa-location-arrow"></i> Google 導航
                </a>
            </div>
        </div>
    </div>
</div>

<!-- PDF 預覽 Modal -->
<div id="pdf-modal" class="pdf-modal">
    <div class="flex justify-between items-center p-4 border-b border-slate-700">
        <h3 class="text-white font-bold flex items-center gap-2">
            <i class="fas fa-ticket-alt text-amber-400"></i> 電子機票預覽
        </h3>
        <div class="flex gap-3">
            <a id="pdf-download-btn" href="#" download
               class="text-xs bg-slate-700 text-white px-3 py-1.5 rounded hover:bg-slate-600 transition">
                <i class="fas fa-download mr-1"></i>下載
            </a>
            <button onclick="closePdfModal()"
                    class="w-8 h-8 bg-slate-700 text-white rounded-full flex items-center justify-center hover:bg-red-500 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="flex-1 p-2 md:p-6 bg-slate-800 relative">
        <div class="w-full h-full bg-white rounded-lg overflow-hidden shadow-2xl relative">
            <iframe id="pdf-frame" src="" class="w-full h-full border-0"></iframe>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none -z-10">
                <span class="text-slate-400 text-sm">
                    <i class="fas fa-spinner fa-spin mr-2"></i>載入文件中...
                </span>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 0. 常數設定 ---
    const CONFIG = {
        TRIP_START_DATE: new Date("2026-01-20T14:25:00"),
        DISTANCE_THRESHOLD_KM: 50,
        NEARBY_RADIUS_KM: 5,
        DEFAULT_ZOOM: 13,
        FOCUS_ZOOM: 16,
        TIMELINE_SCROLL_OFFSET: 80
    };

    const FLIGHT_INFO = {
        outbound: {
            logo: "images/china_air.svg",
            code: "CI 108",
            dept: "14:25",
            arr: "18:30",
            from: "TPE",
            to: "NRT",
            term: "T2",
            ticket: "pdf/ticket_outbound.pdf"
        },
        inbound: {
            logo: "images/jetstar.png",
            code: "GK 55",
            dept: "14:50",
            arr: "17:10",
            from: "KIX",
            to: "TPE",
            term: "T1",
            ticket: "pdf/ticket_inbound.pdf"
        }
    };

    const TYPE_CONFIG = {
        food: {color: 'bg-food', icon: 'utensils', tagClass: 'bg-amber-500'},
        hotel: {color: 'bg-hotel', icon: 'bed', tagClass: 'bg-blue-500'},
        transport: {color: 'bg-transport', icon: 'train', tagClass: 'bg-emerald-500'},
        spot: {color: 'bg-spot', icon: 'camera', tagClass: 'bg-red-500'},
        event: {color: 'bg-spot', icon: 'fire', tagClass: 'bg-purple-500'}
    };

    const itinerary = [
        {
            day: "Day 1", date: "1/20 (二)", fullDate: "2026-01-20",
            items: [
                {
                    type: "flight-out",
                    coords: [35.7719, 140.3906],
                    title: "飛往東京",
                    path: [[25.0797, 121.2342], [35.7719, 140.3906]]
                },
                {
                    time: "20:25<br>OR<br>20:45",
                    type: "transport",
                    title: "Skyliner 直達上野",
                    icon: "train",
                    coords: [35.7137, 139.7772],
                    img: "images/skyliner.jpg",
                    desc: "成田機場進入東京市區最舒適快速的選擇,只要約 41 分鐘即可抵達上野。",
                    tips: "事先上網買好票,進站直接掃 QR Code 劃位。"
                },
                {
                    time: "21:00",
                    type: "hotel",
                    title: "MYSTAYS 上野東酒店 Check-in",
                    icon: "bed",
                    coords: [35.712644374582794, 139.7820110809156],
                    img: "images/ueno_hotel.jpg",
                    desc: "位於交通樞紐上野站旁,周邊生活機能極佳。",
                    tips: "Check-in 後將不需要的大件行李寄往京都飯店。"
                },
                {
                    time: "21:40",
                    type: "food",
                    title: "鴨to蔥",
                    icon: "bowl-rice",
                    coords: [35.70851616118359, 139.77532879812566],
                    img: "images/ichiran.jpg",
                    desc: "以鴨肉與多種蔥段燉出的清爽湯頭,在在地相當有人氣。",
                    tips: "必點鴨拉麵 + 小鴨肉親子丼。"
                }
            ]
        },
        {
            day: "Day 2", date: "1/21 (三)", fullDate: "2026-01-21",
            items: [
                {
                    time: "10:00",
                    type: "transport",
                    title: "上野 → 淺草 (銀座線)",
                    icon: "subway",
                    coords: [35.7111, 139.7731],
                    desc: "搭乘銀座線往淺草方向。",
                    tips: "銀座線淺草站 1 號出口離雷門最近。"
                },
                {
                    time: "10:15",
                    type: "spot",
                    title: "淺草雷門 & 仲見世通",
                    icon: "gopuram",
                    coords: [35.7111, 139.7963],
                    img: "images/sensoji.jpg",
                    desc: "趁團客大量湧入前先拍經典大燈籠。",
                    tips: "10:30 前完成拍照可避開最大人潮。"
                },
                {
                    time: "11:00",
                    type: "food",
                    title: "午餐",
                    icon: "utensils",
                    coords: [35.71292121006034, 139.79570947114155],
                    img: "images/food_asakusa.jpg",
                    desc: "前往大黑家或鰻鐵,建議提前 20 分鐘排隊。",
                    tips: "11:30 開店前抵達可進入第一輪。"
                },
                {
                    time: "12:45",
                    type: "spot",
                    title: "淺草寺本堂參拜",
                    icon: "torii-gate",
                    coords: [35.7148, 139.7967],
                    desc: "吃飽後悠閒參拜,順便抽籤。",
                    tips: "若抽到凶記得綁在架上化解。"
                },
                {
                    time: "13:15",
                    type: "transport",
                    title: "隅田川步道",
                    icon: "bridge",
                    coords: [35.7128, 139.8005],
                    img: "images/sumida_walk.jpg",
                    desc: "沿步道看電車、拍晴空塔與河景。",
                    tips: "動線:淺草寺 → 隅田公園 → 步道橋 → 晴空塔。"
                },
                {
                    time: "13:45",
                    type: "spot",
                    title: "晴空塔 東京晴空街道",
                    icon: "building-store",
                    coords: [35.7100, 139.8107],
                    img: "images/skytree_mall.jpg",
                    desc: "進商場取暖,可到 30F/31F 免費觀景層。",
                    tips: "順便上廁所、補充熱量,準備後續車程。"
                },
                {
                    time: "14:50",
                    type: "transport",
                    title: "押上 → 澀谷 (半藏門線)",
                    icon: "train-subway",
                    coords: [35.7107, 139.8130],
                    desc: "半藏門線直達澀谷約 32 分鐘。",
                    tips: "比銀座線更快且免轉車。"
                },
                {
                    time: "15:45",
                    type: "spot",
                    title: "Shibuya Sky",
                    icon: "cloud-sun",
                    coords: [35.6585, 139.7013],
                    img: "images/shibuyasky.jpg",
                    desc: "日落時段景色最佳,建議預留排隊時間。",
                    tips: "露天區禁止圍巾、帽子、腳架,務必先寄物。"
                },
                {
                    time: "18:30",
                    type: "food",
                    title: "澀谷晚餐",
                    icon: "fire-burner",
                    coords: [35.6595, 139.7005],
                    desc: "看完夜景後直接覓食。",
                    tips: "用餐完可逛 MEGA Don Quijote 補貨。"
                }
            ]
        },
        {
            day: "Day 3", date: "1/22 (四)", fullDate: "2026-01-22",
            items: [
                {
                    time: "08:30",
                    type: "spot",
                    title: "東京迪士尼樂園",
                    icon: "wand-magic-sparkles",
                    coords: [35.6329, 139.8804],
                    img: "images/disney.jpg",
                    desc: "整日樂園行程,體驗經典設施與遊行。",
                    tips: "入園第一件事: 打開 App 抽『美女與野獸』付費 DPA。"
                }
            ]
        },
        {
            day: "Day 4", date: "1/23 (五)", fullDate: "2026-01-23",
            items: [
                {
                    time: "10:00",
                    type: "transport",
                    title: "上野 → 品川 (寄放行李)",
                    icon: "suitcase-rolling",
                    coords: [35.628698005803386, 139.7387489674344],
                    desc: "先搭上野東京線到品川,將大件行李寄放。",
                    tips: "建議選靠近新幹線入口的置物櫃。"
                },
                {
                    time: "11:00",
                    type: "food",
                    title: "築地場外市場 (午餐)",
                    icon: "fish-fins",
                    coords: [35.6654, 139.7706],
                    img: "images/tsukiji.jpg",
                    desc: "中午來人潮相對舒適,邊走邊吃海鮮。",
                    tips: "可品嚐玉子燒、黑鮪魚握壽司或牛丼。"
                },
                {
                    time: "15:28",
                    type: "transport",
                    title: "新幹線 -> 京都",
                    icon: "train-subway",
                    coords: [35.628698005803386, 139.7387489674344],
                    img: "images/shinkansen.jpg",
                    desc: "從品川搭新幹線直達京都。",
                    tips: "選 E 席(右側靠窗)有機會看到富士山。"
                },
                {
                    time: "18:10",
                    type: "hotel",
                    title: "Kabin Taka Check-in",
                    icon: "key",
                    coords: [35.000648142573915, 135.7653011097224],
                    img: "images/kyoto_hotel.jpg",
                    desc: "設計感強且位置佳,適合作為京都基地。",
                    tips: "附近便利商店多,可先買好隔天早餐。"
                }
            ]
        },
        {
            day: "Day 5", date: "1/24 (六)", fullDate: "2026-01-24",
            items: [
                {
                    time: "18:15",
                    type: "event",
                    title: "若草山燒山祭",
                    icon: "fire",
                    coords: [34.6905, 135.8505],
                    img: "images/fire.jpg",
                    desc: "整座若草山被點燃,搭配煙火的壯觀祭典。",
                    tips: "奈良山上冬夜極冷,務必穿足夠保暖衣物與暖暖包。"
                }
            ]
        },
        {
            day: "Day 6", date: "1/25 (日)", fullDate: "2026-01-25",
            items: [
                {
                    time: "10:30",
                    type: "spot",
                    title: "貴船神社",
                    icon: "water",
                    coords: [35.1215, 135.7628],
                    img: "images/kifune.jpg",
                    desc: "紅燈籠參道加上雪景,是京都冬季經典畫面。",
                    tips: "一定要體驗『水占卜』,看文字慢慢浮現。"
                },
                {
                    time: "14:30",
                    type: "spot",
                    title: "賀茂御祖神社(下鴨神社)",
                    icon: "fan",
                    coords: [35.03913589111768, 135.77301752507933],
                    img: "images/gion.jpg",
                    desc: "保留古老町家建築與藝妓文化氛圍。",
                    tips: "嚴禁觸碰藝妓、阻擋道路或使用腳架。"
                }
            ]
        },
        {
            day: "Day 7", date: "1/26 (一)", fullDate: "2026-01-26",
            items: [
                {
                    time: "10:30",
                    type: "spot",
                    title: "清水寺",
                    icon: "place-of-worship",
                    coords: [34.9948, 135.7850],
                    img: "images/kiyomizu.jpg",
                    desc: "京都代表景點,清水舞台視野絕佳。",
                    tips: "音羽之瀧三道水流只能選一道喝,不要貪心。"
                }
            ]
        },
        {
            day: "Day 8", date: "1/27 (二)", fullDate: "2026-01-27",
            items: [
                {
                    time: "11:30",
                    type: "transport",
                    title: "Haruka -> 機場",
                    icon: "train",
                    coords: [34.9858, 135.7587],
                    img: "images/haruka.jpg",
                    desc: "搭乘 Hello Kitty 彩繪 Haruka 前往關西機場。",
                    tips: "建議事先購入優惠電子票。"
                },
                {
                    time: "13:00",
                    type: "transport",
                    title: "關西機場 報到",
                    icon: "suitcase",
                    coords: [34.4320, 135.2303],
                    img: "images/kix.jpg",
                    desc: "辦理登機與最後免稅採買。",
                    tips: "建議起飛前 2.5–3 小時抵達機場較保險。"
                },
                {
                    type: "flight-in",
                    coords: [34.4320, 135.2303],
                    title: "飛往桃園",
                    path: [[34.4320, 135.2303], [25.0797, 121.2342]]
                }
            ]
        }
    ];

    const landmarksDB = [
        {name: "上野公園", coords: [35.7140, 139.7740], q: "Ueno Park", img: "images/ueno_park.jpg", icon: "tree"},
        {name: "東京晴空塔", coords: [35.7100, 139.8107], q: "Tokyo Skytree", img: "images/skytree.jpg", icon: "location-arrow"},
        {name: "東京鐵塔", coords: [35.6585, 139.7454], q: "Tokyo Tower", img: "images/tokyo_tower.jpg", icon: "tower-broadcast"},
        {name: "京都塔", coords: [34.9875, 135.7594], q: "Kyoto Tower", img: "images/kyoto_tower.jpg", icon: "tower-observation"},
        {name: "伏見稻荷", coords: [34.9671, 135.7726], q: "Fushimi Inari", img: "images/fushimi.jpg", icon: "torii-gate"},
        {name: "大阪城", coords: [34.6873, 135.5262], q: "Osaka Castle", img: "images/osaka_castle.jpg", icon: "chess-rook"},
        {name: "秋葉原", coords: [35.6983, 139.7730], q: "Akihabara", img: "images/akihabara.jpg", icon: "gamepad"},
        {name: "錦市場", coords: [35.0050, 135.7631], q: "Nishiki Market", img: "images/nishiki.jpg", icon: "fish"},
        {name: "道頓堀", coords: [34.6687, 135.5012], q: "Dotonbori", img: "images/dotonbori.jpg", icon: "person-running"}
    ];

    // --- 輔助函數 ---
    function getTypeConfig(type) {
        const baseType = String(type || '').split('(')[0];
        return TYPE_CONFIG[baseType] || TYPE_CONFIG.spot;
    }

    function getFallbackImage(keywordLike) {
        const raw = String(keywordLike || 'japan').split(' ')[0];
        const encoded = encodeURIComponent(raw + ',japan');
        return `https://source.unsplash.com/400x300/?${encoded}`;
    }

    function handleImageError(img, fallbackUrl) {
        img.onerror = null;
        img.src = fallbackUrl;
    }

    function parseTimeToMinutes(timeStr) {
        if (!timeStr) return null;
        const match = String(timeStr).match(/(\d{1,2}):(\d{2})/);
        if (!match) return null;
        const h = parseInt(match[1], 10);
        const m = parseInt(match[2], 10);
        if (Number.isNaN(h) || Number.isNaN(m)) return null;
        return h * 60 + m;
    }

    function getDayIndexFromUrl() {
        try {
            const url = new URL(window.location.href);
            let dayParam = url.searchParams.get('day');

            if (!dayParam && url.hash) {
                const hashMatch = url.hash.match(/day=(\d+)/);
                if (hashMatch) dayParam = hashMatch[1];
            }

            if (!dayParam) return null;
            const dayNum = parseInt(dayParam, 10);
            if (Number.isNaN(dayNum)) return null;

            const idx = dayNum - 1;
            if (idx < 0 || idx >= itinerary.length) return null;
            return idx;
        } catch (e) {
            console.warn('URL parse error:', e);
            return null;
        }
    }

    function updateUrlDayParam(index) {
        try {
            const dayNum = index + 1;
            const url = new URL(window.location.href);
            url.searchParams.set('day', String(dayNum));
            url.hash = `day=${dayNum}`;
            window.history.replaceState(null, '', url.toString());
        } catch (e) {
            console.warn('URL update error:', e);
        }
    }

    function isSameDate(today, fullDateStr) {
        const d = new Date(fullDateStr + 'T00:00:00');
        return today.toDateString() === d.toDateString();
    }

    // --- 地圖初始化 ---
    const map = L.map('map', {zoomControl: false}).setView([35.7137, 139.7772], CONFIG.DEFAULT_ZOOM);
    L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
        {maxZoom: 19, attribution: '© OpenStreetMap'}
    ).addTo(map);

    const markersGroup = L.layerGroup().addTo(map);
    const nearbyGroup = L.layerGroup().addTo(map);
    const routeGroup = L.layerGroup().addTo(map);

    let activeDayIndex = 0;
    let sheetState = 0;
    const sheetStates = ['sheet-half', 'sheet-full', 'sheet-min'];
    let currentUserLoc = null;
    let userMarker = null;

    function init() {
        renderTabs();
        startCountdown();
        autoSelectDay();
        map.locate({setView: false, maxZoom: CONFIG.FOCUS_ZOOM});
    }

    // 自動依 URL / 日期選日
    function autoSelectDay() {
        const urlIndex = getDayIndexFromUrl();
        if (urlIndex !== null) {
            selectDay(urlIndex);
            return;
        }

        const now = new Date();
        let targetIndex = 0;

        for (let i = 0; i < itinerary.length; i++) {
            const d = new Date(itinerary[i].fullDate + "T00:00:00");
            const next = new Date(d);
            next.setDate(next.getDate() + 1);

            if (now >= d && now < next) {
                targetIndex = i;
                break;
            }
            if (now > d) targetIndex = i;
        }

        selectDay(targetIndex);
    }

    function cycleSheetHeight() {
        const sheet = document.getElementById('bottom-sheet');
        sheet.classList.remove(sheetStates[sheetState]);
        sheetState = (sheetState + 1) % 3;
        sheet.classList.add(sheetStates[sheetState]);

        if (sheetState !== 1) {
            const first = itinerary[activeDayIndex].items[0];
            if (first && first.coords) {
                flyToLoc(first.coords[0], first.coords[1], true);
            }
        }
    }

    function setSheetState(stateIndex) {
        const sheet = document.getElementById('bottom-sheet');
        sheet.classList.remove(sheetStates[sheetState]);
        sheetState = stateIndex;
        sheet.classList.add(sheetStates[sheetState]);
    }

    function startCountdown() {
        const area = document.getElementById('countdown-area');

        function update() {
            const now = new Date();
            const diff = CONFIG.TRIP_START_DATE - now;
            if (diff <= 0) {
                area.innerHTML =
                    `<div class="m-4 mb-0 p-4 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl text-white shadow-lg flex items-center gap-3">
                        <i class="fas fa-camera text-2xl animate-pulse"></i>
                        <div class="font-bold text-lg">旅程進行中! Have fun!</div>
                     </div>`;
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            area.innerHTML =
                `<div class="m-4 mb-0 p-4 bg-gradient-to-br from-violet-600 via-indigo-600 to-blue-600 rounded-2xl text-white shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i class="fas fa-plane text-6xl transform -rotate-12"></i>
                    </div>
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mb-2">Flight to Japan</div>
                            <div class="flex gap-2">
                                <div class="countdown-box">
                                    <div class="text-xl font-black font-mono">${d}</div>
                                    <div class="countdown-label">Days</div>
                                </div>
                                <div class="countdown-box">
                                    <div class="text-xl font-black font-mono">${h}</div>
                                    <div class="countdown-label">Hrs</div>
                                </div>
                                <div class="countdown-box">
                                    <div class="text-xl font-black font-mono">${m}</div>
                                    <div class="countdown-label">Min</div>
                                </div>
                                <div class="countdown-box">
                                    <div class="text-xl font-black font-mono">${s}</div>
                                    <div class="countdown-label">Sec</div>
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>`;
        }

        setInterval(update, 1000);
        update();
    }

    function selectDay(index) {
        activeDayIndex = index;
        const data = itinerary[index];

        document.querySelectorAll('.day-pill').forEach(el => el.classList.remove('active'));
        const tab = document.getElementById(`tab-${index}`);
        if (tab) {
            tab.classList.add('active');
            tab.scrollIntoView({behavior: 'smooth', inline: 'center'});
        }

        document.getElementById('day-title').innerText = data.day;
        document.getElementById('day-date').innerText = data.date;
        updateUrlDayParam(index);

        const first = data.items[0];
        if (first && first.coords) {
            fetchWeather(first.coords[0], first.coords[1]);
            updateNearby(first.coords);
        }

        renderTimeline(data);
        updateMap(data);

        setTimeout(() => autoScrollTimelineForDay(data), 50);

        if (window.innerWidth < 768) setSheetState(0);
    }

    function autoScrollTimelineForDay(dayData) {
        const today = new Date();
        if (!isSameDate(today, dayData.fullDate)) return;

        const nowMinutes = today.getHours() * 60 + today.getMinutes();
        const timedItems = [];

        dayData.items.forEach((item, idx) => {
            const minutes = parseTimeToMinutes(item.time);
            if (minutes !== null) timedItems.push({idx, minutes});
        });

        if (timedItems.length === 0) return;

        timedItems.sort((a, b) => a.minutes - b.minutes);

        let target = timedItems[timedItems.length - 1];
        for (const t of timedItems) {
            if (t.minutes >= nowMinutes) {
                target = t;
                break;
            }
        }

        const container = document.getElementById('timeline-container');
        const el = container.querySelector(`.timeline-item[data-index="${target.idx}"]`);
        if (!el) return;

        const offsetTop = el.offsetTop - CONFIG.TIMELINE_SCROLL_OFFSET;
        container.scrollTo({top: offsetTop < 0 ? 0 : offsetTop, behavior: 'smooth'});
    }

    function renderTimeline(data) {
        const container = document.getElementById('timeline-container');
        container.innerHTML = data.items.map((item, i) => {
            if (item.type && item.type.includes("flight")) {
                const f = item.type === "flight-out" ? FLIGHT_INFO.outbound : FLIGHT_INFO.inbound;
                return `
                <div class="mb-5 pl-5 cursor-pointer transform transition active:scale-[0.98]" onclick="openTicket('${f.ticket}')">
                    <div class="flight-card relative group">
                        <div class="absolute inset-0 bg-blue-500/0 group-hover:bg-blue-500/5 transition z-10"></div>
                        <div class="p-3 bg-slate-50 border-b border-dashed border-slate-300 flex justify-between items-center">
                            <img src="${f.logo}" alt="${f.code}" class="h-6 object-contain">
                            <span class="font-mono text-xs font-bold text-slate-400 flex items-center gap-1">
                                <i class="fas fa-file-pdf text-red-500"></i> ${f.code}
                            </span>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <div>
                                <div class="text-2xl font-black text-slate-800 font-mono">${f.dept}</div>
                                <div class="text-xs text-slate-400 font-bold mt-1">
                                    ${f.from} <span class="bg-slate-100 px-1 rounded">${f.term}</span>
                                </div>
                            </div>
                            <div class="flex-1 px-4 text-center">
                                <div class="text-[10px] text-blue-500 font-bold mb-1">查看機票</div>
                                <i class="fas fa-plane text-blue-300 transform rotate-90 md:rotate-0"></i>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-slate-800 font-mono">${f.arr}</div>
                                <div class="text-xs text-slate-400 font-bold mt-1">${f.to}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            const fallbackImg = getFallbackImage(item.title);
            const typeConfig = getTypeConfig(item.type);

            return `
            <div class="timeline-item relative flex gap-3 pl-14 group" data-index="${i}">
                <div class="timeline-line absolute left-[50px] top-8 bottom-[-16px] w-0.5 bg-slate-200 z-0"></div>
                <div class="absolute left-2 top-1 text-[11px] font-bold text-slate-400 w-10 text-right font-mono">
                    ${item.time || ''}
                </div>
                <div class="flex-1 bg-white border border-slate-100 p-3 rounded-2xl shadow-sm flex gap-3 transition hover:shadow-md cursor-pointer relative z-10"
                     onclick="focusItem(${i})">
                    ${item.img ? `
                        <img src="${item.img}"
                             onerror="handleImageError(this, '${fallbackImg}')"
                             alt="${item.title}"
                             class="w-20 h-20 rounded-xl object-cover bg-slate-100 flex-shrink-0">
                    ` : ''}
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-1.5 mb-1">
                            <span class="w-2 h-2 rounded-full ${typeConfig.color}"></span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">${item.type}</span>
                        </div>
                        <h3 class="font-bold text-slate-800 text-sm leading-snug mb-2 truncate">${item.title}</h3>
                        <button class="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded-full font-bold transition flex items-center w-fit"
                                onclick="event.stopPropagation(); openModal(${i})">
                            <i class="fas fa-info-circle mr-1"></i>詳細資訊
                        </button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function showRouteTo(lat, lon) {
        routeGroup.clearLayers();
        if (!currentUserLoc) return false;

        const dist = getDistance([currentUserLoc.lat, currentUserLoc.lng], [lat, lon]).toFixed(1);

        L.marker([lat, lon], {
            icon: L.divIcon({
                className: 'dist-label-icon',
                html: `<div class="dist-label-container">
                        <div class="dist-label">
                            <i class="fas fa-location-arrow text-sky-300"></i>
                            <span>距您 ${dist} km</span>
                        </div>
                       </div>`,
                iconSize: [160, 40],
                iconAnchor: [80, 0]
            })
        }).addTo(routeGroup);

        if (parseFloat(dist) > CONFIG.DISTANCE_THRESHOLD_KM) {
            flyToLoc(lat, lon);
            return true;
        }

        const latlngs = [currentUserLoc, [lat, lon]];
        L.polyline(latlngs, {
            color: '#6366f1',
            weight: 4,
            opacity: 0.8,
            dashArray: '10, 10',
            lineCap: 'round'
        }).addTo(routeGroup);

        const isMobile = window.innerWidth < 768;
        let bottomPad = 50;
        if (isMobile) {
            if (sheetState === 0) bottomPad = window.innerHeight * 0.55;
            else if (sheetState === 2) bottomPad = 180;
        }

        map.fitBounds(latlngs, {
            paddingTopLeft: [50, 50],
            paddingBottomRight: [50, bottomPad]
        });
        return true;
    }

    function focusItem(index) {
        const item = itinerary[activeDayIndex].items[index];
        if (!item) return;

        if (sheetState === 1 && window.innerWidth < 768) setSheetState(0);

        if (item.path && item.path.length >= 2 && item.coords) {
            map.fitBounds(item.path, {padding: [50, 50]});
            updateNearby(item.coords);
        } else if (item.coords) {
            const hasRoute = showRouteTo(item.coords[0], item.coords[1]);
            if (!hasRoute) flyToLoc(item.coords[0], item.coords[1]);
            updateNearby(item.coords);
        }
    }

    function flyToLoc(lat, lon, forceNoPadding = false) {
        const isMobile = window.innerWidth < 768;
        let paddingOptions = {};

        if (isMobile && !forceNoPadding) {
            let offsetY = 0;
            if (sheetState === 0) offsetY = window.innerHeight * 0.25;
            paddingOptions = {paddingBottomRight: [0, offsetY * 2]};
        }
        map.flyTo([lat, lon], CONFIG.FOCUS_ZOOM, {
            animate: true,
            duration: 1.2,
            ...paddingOptions
        });
    }

    function navigateToLandmark(lat, lon) {
        if (sheetState === 1 && window.innerWidth < 768) setSheetState(0);

        nearbyGroup.eachLayer(layer => {
            if (layer._icon) layer._icon.classList.remove('active');
        });

        const hasRoute = showRouteTo(lat, lon);
        if (!hasRoute) flyToLoc(lat, lon);
    }

    function updateMap(data) {
        markersGroup.clearLayers();
        routeGroup.clearLayers();
        const points = [];

        data.items.forEach((item, i) => {
            if (item.path && item.coords) {
                L.polyline(item.path, {
                    color: '#6366f1',
                    weight: 3,
                    dashArray: '10, 10'
                }).addTo(markersGroup);
                L.marker(item.coords, {
                    icon: L.divIcon({
                        html: '<i class="fas fa-plane text-indigo-500 text-2xl transform -rotate-45"></i>',
                        className: 'bg-transparent'
                    })
                }).addTo(markersGroup);
                points.push(item.coords);
            } else if (item.coords) {
                const typeConfig = getTypeConfig(item.type);
                const iconName = item.icon || typeConfig.icon;

                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-marker ${typeConfig.color}">
                              <i class="fas fa-${iconName}"></i>
                           </div>`,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                const marker = L.marker(item.coords, {icon: icon}).addTo(markersGroup);
                marker.on('click', () => {
                    focusItem(i);
                    if (!item.path) openModal(i);
                });
                points.push(item.coords);
            }
        });

        if (points.length > 0 && !data.items[0].path) {
            map.fitBounds(points, {padding: [100, 100]});
        }
    }

    function updateNearby(center) {
        const list = document.getElementById('nearby-list');
        nearbyGroup.clearLayers();
        if (!center) return;

        const nearby = landmarksDB
            .map(s => ({...s, dist: getDistance(center, s.coords)}))
            .filter(s => s.dist <= CONFIG.NEARBY_RADIUS_KM)
            .sort((a, b) => a.dist - b.dist);

        nearby.forEach(s => {
            const iconName = s.icon || 'map-marker-alt';
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="custom-marker bg-nearby">
                         <i class="fas fa-${iconName}"></i>
                       </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            const marker = L.marker(s.coords, {icon: icon}).addTo(nearbyGroup);
            marker.on('click', () => {
                navigateToLandmark(s.coords[0], s.coords[1]);
            });
        });

        if (nearby.length === 0) {
            list.innerHTML = `<div class="text-xs text-slate-400 py-4 pl-4">附近無特定地標</div>`;
            return;
        }

        list.innerHTML = nearby.map(s => {
            const fallbackImg = getFallbackImage(s.q);
            const imgSrc = s.img || fallbackImg;
            return `
            <div class="flex-shrink-0 w-32 bg-white rounded-xl border border-slate-100 overflow-hidden cursor-pointer active:scale-95 transition"
                 onclick="navigateToLandmark(${s.coords[0]}, ${s.coords[1]})">
                <div class="h-20 relative">
                    <img src="${imgSrc}"
                         onerror="handleImageError(this, '${fallbackImg}')"
                         alt="${s.name}"
                         class="w-full h-full object-cover">
                    <div class="absolute bottom-1 right-1 bg-black/60 text-white text-[9px] px-1.5 rounded backdrop-blur-sm">
                        ${s.dist.toFixed(1)}km
                    </div>
                </div>
                <div class="p-2">
                    <h4 class="text-xs font-bold text-slate-800 truncate">${s.name}</h4>
                </div>
            </div>`;
        }).join('');
    }

    function getDistance(c1, c2) {
        const R = 6371;
        const dLat = (c2[0] - c1[0]) * Math.PI / 180;
        const dLon = (c2[1] - c1[1]) * Math.PI / 180;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(c1[0] * Math.PI / 180) * Math.cos(c2[0] * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function fetchWeather(lat, lon) {
        const iconEl = document.getElementById('weather-icon');
        const tempEl = document.getElementById('weather-temp');
        const descEl = document.getElementById('weather-desc');
        descEl.innerText = "載入中";
        iconEl.className = "fas fa-spinner fa-spin text-slate-400";

        try {
            const res = await fetch(
                `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=apparent_temperature`
            );
            if (!res.ok) throw new Error('Weather API request failed');

            const d = await res.json();
            const code = d.current_weather.weathercode;
            const temp = Math.round(d.current_weather.temperature);
            const isDay = d.current_weather.is_day;

            let text = "晴朗", icon = isDay ? "fa-sun text-orange-400" : "fa-moon text-yellow-300";

            if (code === 0) {
            } else if (code >= 1 && code <= 3) {
                text = "多雲";
                icon = "fa-cloud text-slate-400";
            } else if (code === 45 || code === 48) {
                text = "有霧";
                icon = "fa-smog text-slate-400";
            } else if (code >= 51 && code <= 55) {
                text = "毛毛雨";
                icon = "fa-cloud-rain text-blue-300";
            } else if (code >= 61 && code <= 65) {
                text = "有雨";
                icon = "fa-umbrella text-blue-500";
            } else if (code >= 66 && code <= 67) {
                text = "凍雨";
                icon = "fa-icicles text-cyan-500";
            } else if (code >= 71 && code <= 77) {
                text = "降雪";
                icon = "fa-snowflake text-sky-300";
            } else if (code >= 80 && code <= 82) {
                text = "陣雨";
                icon = "fa-cloud-showers-heavy text-blue-600";
            } else if (code >= 85 && code <= 86) {
                text = "暴雪";
                icon = "fa-snowflake text-white";
            } else if (code >= 95) {
                text = "雷雨";
                icon = "fa-bolt text-yellow-500";
            }

            tempEl.innerText = `${temp}°`;
            descEl.innerText = text;
            iconEl.className = `fas ${icon}`;
        } catch (e) {
            console.error('Weather fetch error:', e);
            tempEl.innerText = "--°";
            descEl.innerText = "無法取得";
            iconEl.className = "fas fa-question text-slate-300";
        }
    }

    function openTicket(filename) {
        if (!filename) {
            alert("找不到機票檔案");
            return;
        }
        document.getElementById('pdf-frame').src = filename;
        document.getElementById('pdf-download-btn').href = filename;
        document.getElementById('pdf-modal').classList.add('open');
    }

    function closePdfModal() {
        document.getElementById('pdf-modal').classList.remove('open');
        setTimeout(() => {
            document.getElementById('pdf-frame').src = '';
        }, 300);
    }

    function openModal(index) {
        const item = itinerary[activeDayIndex].items[index];
        if (!item || (item.type && item.type.includes("flight"))) return;

        const modal = document.getElementById('detail-modal');
        const fallbackImg = getFallbackImage(item.title);
        const modalImgEl = document.getElementById('modal-img');
        const typeConfig = getTypeConfig(item.type);

        modalImgEl.src = item.img || fallbackImg;
        modalImgEl.onerror = function () {
            handleImageError(this, fallbackImg);
        };

        const tagEl = document.getElementById('modal-tag');
        tagEl.innerText = String(item.type || '').toUpperCase();
        tagEl.className =
            `text-xs font-bold px-2 py-0.5 rounded inline-block mb-1 text-white ${typeConfig.tagClass}`;

        document.getElementById('modal-title').innerText = item.title;
        document.getElementById('modal-desc').innerText = item.desc || "暫無詳細介紹";
        document.getElementById('modal-tips').innerText = item.tips || "記得多拍照!";
        document.getElementById('modal-nav-btn').href =
            `https://www.google.com/maps/dir/?api=1&destination=${item.coords[0]},${item.coords[1]}`;

        modal.classList.add('open');
    }

    function closeModal() {
        document.getElementById('detail-modal').classList.remove('open');
    }

    function renderTabs() {
        document.getElementById('day-tabs').innerHTML = itinerary.map((d, i) =>
            `<button onclick="selectDay(${i})"
                     id="tab-${i}"
                     class="day-pill flex-shrink-0 px-5 py-2 rounded-full text-sm font-bold border border-slate-200 bg-white text-slate-500 shadow-sm whitespace-nowrap">
                ${d.day}
             </button>`
        ).join('');
    }

    function locateUser(setView = true) {
        map.locate({setView: setView, maxZoom: CONFIG.FOCUS_ZOOM});
    }

    map.on('locationfound', (e) => {
        currentUserLoc = e.latlng;

        if (userMarker) {
            userMarker.setLatLng(e.latlng);
        } else {
            userMarker = L.marker(e.latlng, {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: `<div class="w-8 h-8 bg-pink-500 rounded-full border-4 border-white shadow-lg flex items-center justify-center animate-bounce text-white text-xs">
                               <i class="fas fa-user"></i>
                           </div>`
                })
            }).addTo(map).bindPopup("你");
        }
        userMarker.openPopup();
    });

    map.on('locationerror', (e) => {
        console.warn('Location error:', e.message);
    });

    init();
</script>
</body>
</html>
